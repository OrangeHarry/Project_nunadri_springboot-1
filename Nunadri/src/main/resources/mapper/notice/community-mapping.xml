<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.springproject.mapper.CommunityMapper">
	<sql id="communityColumns">
			  NOTICE_CATEGORY
			, NOTICE_NO
			, NICKNAME
			, NOTICE_REGDATE
			, NOTICE_TITLE
			, NOTICE_CONTENT
			, NOTICE_HIT
			, NOTICE_PICTURE
	</sql>
		
		<insert id="insertCommunity">
			INSERT INTO projectdb.NOTICE_COMMUNITY 
		(
			 NOTICE_NO
			, NOTICE_CATEGORY
			, NICKNAME
			, NOTICE_REGDATE
			, NOTICE_TITLE
			, NOTICE_CONTENT
			, NOTICE_HIT
			, NOTICE_PICTURE
			
    		) values (
    			(SELECT 
					IFNULL(MAX(NOTICE_NO), 0) + 1 
				FROM 
					projectdb.NOTICE_COMMUNITY ALIAS_FOR_SUBQUERY 
				WHERE 
					NOTICE_CATEGORY = #{noticeCategory})
									, #{noticeCategory}
									, #{nickname}
									, date_format(now(), '%Y-%m-%d %H:%m')
									, #{noticeTitle}
									, #{noticeContent}
									, #{noticeHit}
									, #{noticePicture}
   		 )	
		</insert>
	
		<select id="getCommunityDetail" parameterType="CommunityVO" resultType="CommunityVO">
			SELECT
				<include refid="communityColumns" />
			FROM
				projectdb.NOTICE_COMMUNITY
			WHERE
				NOTICE_CATEGORY = #{noticeCategory}
			AND
				NOTICE_NO = #{noticeNo}
		</select>
		
		<!-- 조회수 증가 쿼리 -->
		<update id="hitIncrease">
			UPDATE NOTICE_COMMUNITY
			SET 
				NOTICE_HIT = NOTICE_HIT + 1 
			WHERE
				 NOTICE_CATEGORY = #{noticeCategory}
        	AND 
        		NOTICE_NO = #{noticeNo}	
		</update>
	
		<update id="updateCommunity" parameterType="CommunityVO">
			UPDATE NOTICE_COMMUNITY
			SET
			NOTICE_CATEGORY = #{noticeCategory}
				, NOTICE_TITLE = #{noticeTitle}
				, NOTICE_CONTENT = #{noticeContent}
			WHERE
				NOTICE_CATEGORY = #{noticeCategory}
			AND
				NOTICE_NO = #{noticeNo}
		</update>
		
		<select id="getCommunity" resultType="CommunityVO">
			SELECT * FROM NOTICE_COMMUNITY
			WHERE
				NOTICE_CATEGORY = #{noticeCategory}
			AND
				NOTICE_NO = #{noticeNo}
		</select>
	
		<delete id="deleteCommunity" parameterType="CommunityVO">
			DELETE FROM NOTICE_COMMUNITY
			WHERE 
				NOTICE_NO = #{noticeNo} 
			AND 
				NOTICE_CATEGORY = #{noticeCategory}
		</delete>
	
		<select id="getCommunityList" resultType="CommunityVO" parameterType="HashMap">
			SELECT 
				<include refid="communityColumns" />
			FROM
			    NOTICE_COMMUNITY
			WHERE
			    NOTICE_CATEGORY = #{noticeCategory}
			<if test="searchCondition == 'NOTICE_TITLE'"> 
            AND 
            	NOTICE_TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
          	</if> 
         	<if test="searchCondition == 'NOTICE_CONTENT'">
            AND 
            	NOTICE_CONTENT LIKE CONCAT('%', #{searchKeyword}, '%')
         	</if> 
         	<if test="searchCondition == 'NICKNAME'">
            AND 
            	NICKNAME LIKE CONCAT('%', #{searchKeyword}, '%')
         	</if>
			ORDER BY NOTICE_NO DESC
			LIMIT 9
		</select>
	
		<insert id="insertCommunityFileList" parameterType="FileCommunityVO">
			INSERT INTO projectdb.file_community
            (
                          FILE_NO
                        , NICKNAME
                        , NOTICE_CATEGORY
                        , NOTICE_NO
                        , NOTICE_FILENAME
                        , NOTICE_FILE_PATH
                        , NOTICE_FILE_SIZE
            ) value (
            	  (SELECT 
                   		IFNULL(MAX(FILE_NO), 0) +1
                   FROM   
                   		file_community ALIAS_FOR_SUBQUERY
                   WHERE  
                   		NOTICE_NO = #{noticeNo}
                   AND    
                   		NOTICE_CATEGORY = #{noticeCategory})
		            , #{nickname}
		            , #{noticeCategory}
		            , #{noticeNo}
		            , #{noticeFileName}
		            , #{noticeFilePath}
		            , #{noticeFileSize}
            );
		</insert>
		
		<select id="getCommunityFileList" parameterType="FileCommunityVO"  resultType="FileCommunityVO">
			SELECT * FROM FILE_COMMUNITY
			WHERE 
				NOTICE_NO = #{noticeNo}
			AND
				NOTICE_CATEGORY = #{noticeCategory}
		</select>
		
		<!-- 파일만 삭제 -->
		<delete id="deleteFile" parameterType="FileCommunityVO">
			DELETE FROM FILE_COMMUNITY
			WHERE 
				NOTICE_CATEGORY = #{noticeCategory}
			AND 
				NOTICE_NO = #{noticeNo}
			AND
				FILE_NO = #{fileNo}
		</delete>
		
		<delete id="deleteFileList" parameterType="FileCommunityVO">
			DELETE FROM FILE_COMMUNITY
			WHERE
				NOTICE_CATEGORY = #{noticeCategory}
			AND
				NOTICE_NO = #{noticeNo}
		</delete>
		
		
		<select id="getCommunityNo" resultType="int">
			SELECT 
				IFNULL(MAX(NOTICE_NO), 0) + 1 
			FROM 
				NOTICE_COMMUNITY
		</select>
		
		<!-- 페이징 카운트 쿼리문 -->
        <select id="selectCommunityCount" resultType="int">
		      SELECT COUNT(*) FROM NOTICE_COMMUNITY 
		      WHERE 
		      		NOTICE_CATEGORY = #{noticeCategory}
            <if test="searchCondition == 'NOTICE_TITLE'">
               AND 
               		NOTICE_TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>
            <if test="searchCondition == 'NOTICE_CONTENT'">
               AND 
               		NOTICE_CONTENT LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>
            <if test="searchCondition == 'NICKNAME'">
                  AND 
                  		NICKNAME LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>
      </select> 
		
		
</mapper>